<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="介绍 #   如果要在 Kubernets 发布一个应用， 并对外提供服务， 需要配置诸如 Dep, Ing, Svc 等 Config API。 他们之间又是通过 Label 组合选择而实现的 松耦合。
 如果想要这些 Config API 之间的关系更加紧密， 我们可以自己再向上抽象， 通过自己的配置将他们整合在一起。 更重要的是， 我们可以通过这层抽象， 屏蔽不同版本 API 之间差异。 实现同一个 kustz.yml 配置兼容多版本集群， 实现部署或迁移的丝滑。  Kustomize #   kustomize: https://kubectl.docs.kubernetes.io/guides/introduction/kustomize/
 现在这个官网的引导页面看起来已经有点乱了。
简单的说， 以下是一个最基本的 kustomization.yaml 文件。
apiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization namespace: demo-demo resources: - deployment.yml - service.yml - ingress.yml  ApiVersion 和 Kind : 对文件的作用定义 Namespace : 服务部署的运行环境。 Resources : 从外部引入的资源， 最终由 kustomize 统一渲染管理。 比如 patch 操作等。  Deployment, Pod 和 Container #  先来说说 Deployment， 这个应该是最常见的 工作负载 workload， 定义 Pod 状态 。"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content><meta property="og:description" content="介绍 #   如果要在 Kubernets 发布一个应用， 并对外提供服务， 需要配置诸如 Dep, Ing, Svc 等 Config API。 他们之间又是通过 Label 组合选择而实现的 松耦合。
 如果想要这些 Config API 之间的关系更加紧密， 我们可以自己再向上抽象， 通过自己的配置将他们整合在一起。 更重要的是， 我们可以通过这层抽象， 屏蔽不同版本 API 之间差异。 实现同一个 kustz.yml 配置兼容多版本集群， 实现部署或迁移的丝滑。  Kustomize #   kustomize: https://kubectl.docs.kubernetes.io/guides/introduction/kustomize/
 现在这个官网的引导页面看起来已经有点乱了。
简单的说， 以下是一个最基本的 kustomization.yaml 文件。
apiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization namespace: demo-demo resources: - deployment.yml - service.yml - ingress.yml  ApiVersion 和 Kind : 对文件的作用定义 Namespace : 服务部署的运行环境。 Resources : 从外部引入的资源， 最终由 kustomize 统一渲染管理。 比如 patch 操作等。  Deployment, Pod 和 Container #  先来说说 Deployment， 这个应该是最常见的 工作负载 workload， 定义 Pod 状态 。"><meta property="og:type" content="article"><meta property="og:url" content="https://books.tangx.in/kustz/01-introduce/"><meta property="article:section" content><title>01 Introduce | kuberbuilder 从零开始</title><link rel=manifest href=/kustz/manifest.json><link rel=icon href=/kustz/favicon.png type=image/x-icon><link rel=stylesheet href=/kustz/book.min.958cea7827621d6fbcb3acf091344c3e44e3d2a9428f9c3c38bb9eb37bf8c45d.css integrity="sha256-lYzqeCdiHW+8s6zwkTRMPkTj0qlCj5w8OLues3v4xF0=" crossorigin=anonymous><script defer src=/kustz/flexsearch.min.js></script><script defer src=/kustz/en.search.min.743601cfae3a98091ab35696d0011b931498a13ce6ae46c97a4c901eb48f55a1.js integrity="sha256-dDYBz646mAkas1aW0AEbkxSYoTzmrkbJekyQHrSPVaE=" crossorigin=anonymous></script><script defer src=/kustz/sw.min.c95c353ce54773578818f3d1f34e30b70ad702a49e5ec75a7d2905d8ce4ed90f.js integrity="sha256-yVw1POVHc1eIGPPR804wtwrXAqSeXsdafSkF2M5O2Q8=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/kustz/><img src=/kustz/logo.png alt=Logo><span>kuberbuilder 从零开始</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><h1 id=kustz>Kustz
<a class=anchor href=#kustz>#</a></h1><p>使用 <code>kustomize</code> 简化 kubernetes 服务部署和配置</p><p><img src=./img/kustz-logo.jpg alt=logo></p><h2 id=目录>目录
<a class=anchor href=#%e7%9b%ae%e5%bd%95>#</a></h2><h3 id=第一章-简介>第一章 简介
<a class=anchor href=#%e7%ac%ac%e4%b8%80%e7%ab%a0-%e7%ae%80%e4%bb%8b>#</a></h3><ul><li><a href=/kustz/01-introduce/ class=active>01. 简介</a></li></ul><h3 id=第二章-基础结构>第二章 基础结构
<a class=anchor href=#%e7%ac%ac%e4%ba%8c%e7%ab%a0-%e5%9f%ba%e7%a1%80%e7%bb%93%e6%9e%84>#</a></h3><ul><li><a href=/kustz/02-1-sample-deployment/>2.1. 模仿 kubectl create 创建 Deployment 样例</a></li><li><a href=/kustz/02-2-define-strings-to-service/>2.2. 定义字符串创建 Service</a></li><li><a href=/kustz/02-3-parse-url-to-ingress/>2.3. 解析 URL 为 Ingress</a></li><li><a href=/kustz/02-4-kustomize/>2.4. kustomize 流水线</a></li><li><a href=/kustz/02-5-kustz-cli/>2.5. 使用 cobra 实现 kustz 命令</a></li></ul><h3 id=第三章-高级扩展>第三章 高级扩展
<a class=anchor href=#%e7%ac%ac%e4%b8%89%e7%ab%a0-%e9%ab%98%e7%ba%a7%e6%89%a9%e5%b1%95>#</a></h3><ul><li><a href=/kustz/03-1-container-env-var/>3.1. 为 Container 添加环境变量</a></li><li><a href=/kustz/03-2-configmap-secret-generator/>3.2. ConfigMap 和 Secret 的生成器</a></li><li><a href=/kustz/03-3-container-env-from/>3.3. 注入 ConfigMap 和 Secrets 到容器环境变量</a></li><li><a href=/kustz/03-4-container-resources/>3.4. 用字符串定义容器申请资源上下限</a></li><li><a href=/kustz/03-5-container-probe/>3.5. 为 Container 添加健康检查方法</a></li><li><a href=/kustz/03-6-image-pull-policy/>3.6. 3.6. 镜像拉取鉴权和策略</a></li></ul><h3 id=第四章-投入使用>第四章 投入使用
<a class=anchor href=#%e7%ac%ac%e5%9b%9b%e7%ab%a0-%e6%8a%95%e5%85%a5%e4%bd%bf%e7%94%a8>#</a></h3><ul><li><a href=/kustz/04-1-kustz-flags/>4.1. 使用 cobrautils 为命令添加更实用的命令参数</a></li></ul><h1 id=请一杯咖啡>请一杯咖啡
<a class=anchor href=#%e8%af%b7%e4%b8%80%e6%9d%af%e5%92%96%e5%95%a1>#</a></h1><p><img src=./img/mp-qrcode.png alt=mp-weixin></p><p>如果你觉得这个项目还不错， 请我一杯咖啡 ☕️ 吧。</p><p><img src=./img/pay/wxpay.png alt=wxpay>
<img src=./img/pay/alipay.jpg alt=alipay></p></nav><script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/kustz/svg/menu.svg class=book-icon alt=Menu></label>
<strong>01 Introduce</strong>
<label for=toc-control><img src=/kustz/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#kustomize>Kustomize</a></li><li><a href=#deployment-pod-和-container>Deployment, Pod 和 Container</a></li><li><a href=#kustz>kustz</a></li></ul></nav></aside></header><article class=markdown><h1 id=介绍>介绍
<a class=anchor href=#%e4%bb%8b%e7%bb%8d>#</a></h1><p><img src=./img/kustz-logo.jpg alt=logo></p><p>如果要在 Kubernets 发布一个应用， 并对外提供服务， 需要配置诸如 <code>Dep, Ing, Svc</code> 等 Config API。
他们之间又是通过 <code>Label</code> 组合选择而实现的 <strong>松耦合</strong>。</p><ol><li>如果想要这些 Config API 之间的关系更加紧密， 我们可以自己再向上抽象， 通过自己的配置将他们整合在一起。</li><li>更重要的是， 我们可以通过这层抽象， 屏蔽不同版本 API 之间差异。 实现同一个 <code>kustz.yml</code> 配置兼容多版本集群， 实现部署或迁移的丝滑。</li></ol><h2 id=kustomize>Kustomize
<a class=anchor href=#kustomize>#</a></h2><blockquote><p>kustomize: <a href=https://kubectl.docs.kubernetes.io/guides/introduction/kustomize/>https://kubectl.docs.kubernetes.io/guides/introduction/kustomize/</a></p></blockquote><p>现在这个官网的引导页面看起来已经有点乱了。</p><p>简单的说， 以下是一个最基本的 <code>kustomization.yaml</code> 文件。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kustomize.config.k8s.io/v1beta1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Kustomization</span>
<span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>demo-demo</span>
<span style=color:#f92672>resources</span>:
  - <span style=color:#ae81ff>deployment.yml</span>
  - <span style=color:#ae81ff>service.yml</span>
  - <span style=color:#ae81ff>ingress.yml</span>
</code></pre></div><ol><li><code>ApiVersion</code> 和 <code>Kind</code> : 对文件的作用定义</li><li><code>Namespace</code> : 服务部署的运行环境。</li><li><code>Resources</code> : 从外部引入的资源， 最终由 <code>kustomize</code> 统一渲染管理。 比如 patch 操作等。</li></ol><h2 id=deployment-pod-和-container>Deployment, Pod 和 Container
<a class=anchor href=#deployment-pod-%e5%92%8c-container>#</a></h2><p>先来说说 Deployment， 这个应该是最常见的 <strong>工作负载 workload</strong>， <strong>定义</strong> Pod 状态 。</p><p>我们都知道， Pod 是 Kubernetes 中最小的 <strong>调度</strong> 单元， 定义网络、存储、权限等信息。</p><p>换而言之， 最小的 <strong>执行</strong> 单元其实还是 Container， 定义了执行</p><p><img src=./img/pod.png alt=pod></p><p>通过 kubectl 命令，生成的最简单的 Deployment 模版。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create deployment my-nginx --image nginx:alpine --dry-run<span style=color:#f92672>=</span>client -o yaml
</code></pre></div><p><img src=./img/dep-pod-container.jpg alt=dep-pod-c></p><ol><li>最外层<strong>红色</strong>是 deployment.</li><li>中间层<strong>蓝色</strong>是 pod.</li><li>最内存<strong>绿色</strong>是 container.</li></ol><p>没错， 他们之间的关系就是套娃， 一层套一层。</p><h2 id=kustz>kustz
<a class=anchor href=#kustz>#</a></h2><p><code>kustz</code> 的作用就如同 <code>Deployment</code> 一样， 将 <strong>应用</strong> 视作一个整体， 通过 <strong>某种</strong> 组织方式， 在一个文件中定义一个 <strong>应用/服务</strong>。</p><ol><li>将所有的配置都集中到 <strong>同一个文件</strong> 中， 多个资源更方便管理。</li><li>将原本复杂的 API 结构 <strong>语义化</strong>， 配置起来更简单。</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># kustz.yml</span>

<span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>demo-demo</span> <span style=color:#75715e># 运行的命名空间</span>

<span style=color:#f92672>service</span>:  <span style=color:#75715e># 定义一个应用</span>
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>srv-webapp-demo</span>
  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/library/nginx:alpine</span>
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>envs</span>:   <span style=color:#75715e># 容器变量配置</span>
    <span style=color:#f92672>pairs</span>:
      <span style=color:#f92672>key1</span>: <span style=color:#ae81ff>value1-123</span>
  <span style=color:#f92672>resources</span>:
    <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>10m/20m</span>
    <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>10Mi/20Mi</span>

  <span style=color:#f92672>probes</span>: <span style=color:#75715e># 容器探针</span>
    <span style=color:#f92672>liveness</span>:
      <span style=color:#f92672>action</span>: <span style=color:#ae81ff>http://:80/liveness</span>

  <span style=color:#f92672>ports</span>: <span style=color:#75715e># Service 端口</span>
    - <span style=color:#e6db74>&#34;80:80&#34;</span>       <span style=color:#75715e># cluster ip</span>

<span style=color:#75715e>## 对外暴露</span>
<span style=color:#f92672>ingress</span>:
  - <span style=color:#ae81ff>http://www.example.com/*</span>
</code></pre></div><blockquote><p>注意: 以上配置文件结构，可能会随着代码开发进行调整。</p></blockquote><p>如此这边，我们就可以通过 <code>kustz.yml</code> 定义完成一个服务的 <strong>完整配置定义</strong> ， 之后再通过 <code>kustz</code> 工具将起转化为 <code>kustomization.yml, deployment.yml ...</code> 等文件， 最后通过 <code>kubectl</code> 工具进行发布管理。</p></article><div class="book-footer justify-between"></div><hr style=height:1px;background:var(--gray-200)><br><p>本图书由<a href=https://github.com/tangx>老麦</a>©2021 版权所有，<a href=https://github.com/tangx/kubebuilder-zero-to-one>所有文章</a>采用<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh>知识署名-非商业性使用-禁止演绎 4.0 国际</a>进行许可。</p><div style=text-align:center><p><img width=70% style=width:70%;height:70%;!important src=http://tangx.in/assets/images/wx-qrcode.png></p></div><script src=https://utteranc.es/client.js repo=tangx/tangx.github.io issue-term=title theme=github-light crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tangx/kubebuilder-zero-to-one/edit/master/./01-introduce.md target=_blank rel=noopener><img src=/kustz/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#kustomize>Kustomize</a></li><li><a href=#deployment-pod-和-container>Deployment, Pod 和 Container</a></li><li><a href=#kustz>kustz</a></li></ul></nav></div></aside></main></body></html>