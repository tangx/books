<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="3.6. 镜像拉取鉴权和策略 #   大家好， 我是老麦。 今天我们解决镜像拉取鉴权和策略
  镜像拉取鉴权 #  拉取私有镜像或私有仓库镜像的时候， 需要提供鉴权信息。
在 Kubernets 中， 通过 Secret 管理账号这些账号信息。 Secret 类型分为两种，
  kubernetes.io/dockerconfigjson: 如果有linux安装了 docker， 就是 ~/.docker/config.json 这个文件。
  kubernetes.io/dockercfg: 不太熟。
  在 /pkg/tokube/pod.go 中， 可以看到 ImagePullSecrets 的处理方法。 就是将字符串转为 kubernetes 的引用对象， 其它没什么好说的。
func ImagePullSecrets(secrets []string) []corev1.LocalObjectReference { if len(secrets) == 0 { return nil } objs := []corev1.LocalObjectReference{} for _, s := range secrets { objs = append(objs, corev1."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content><meta property="og:description" content="3.6. 镜像拉取鉴权和策略 #   大家好， 我是老麦。 今天我们解决镜像拉取鉴权和策略
  镜像拉取鉴权 #  拉取私有镜像或私有仓库镜像的时候， 需要提供鉴权信息。
在 Kubernets 中， 通过 Secret 管理账号这些账号信息。 Secret 类型分为两种，
  kubernetes.io/dockerconfigjson: 如果有linux安装了 docker， 就是 ~/.docker/config.json 这个文件。
  kubernetes.io/dockercfg: 不太熟。
  在 /pkg/tokube/pod.go 中， 可以看到 ImagePullSecrets 的处理方法。 就是将字符串转为 kubernetes 的引用对象， 其它没什么好说的。
func ImagePullSecrets(secrets []string) []corev1.LocalObjectReference { if len(secrets) == 0 { return nil } objs := []corev1.LocalObjectReference{} for _, s := range secrets { objs = append(objs, corev1."><meta property="og:type" content="article"><meta property="og:url" content="https://books.tangx.in/kustz/03-6-image-pull-policy/"><meta property="article:section" content><title>03 6 Image Pull Policy | kuberbuilder 从零开始</title><link rel=manifest href=/kustz/manifest.json><link rel=icon href=/kustz/favicon.png type=image/x-icon><link rel=stylesheet href=/kustz/book.min.958cea7827621d6fbcb3acf091344c3e44e3d2a9428f9c3c38bb9eb37bf8c45d.css integrity="sha256-lYzqeCdiHW+8s6zwkTRMPkTj0qlCj5w8OLues3v4xF0=" crossorigin=anonymous><script defer src=/kustz/flexsearch.min.js></script><script defer src=/kustz/en.search.min.b9d8c85edd90596233da86b293de906d80f21eaf7c5a9d1e202761f136afc2d1.js integrity="sha256-udjIXt2QWWIz2oayk96QbYDyHq98Wp0eICdh8TavwtE=" crossorigin=anonymous></script><script defer src=/kustz/sw.min.c95c353ce54773578818f3d1f34e30b70ad702a49e5ec75a7d2905d8ce4ed90f.js integrity="sha256-yVw1POVHc1eIGPPR804wtwrXAqSeXsdafSkF2M5O2Q8=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/kustz/><img src=/kustz/logo.png alt=Logo><span>kuberbuilder 从零开始</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div></nav><script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/kustz/svg/menu.svg class=book-icon alt=Menu></label>
<strong>03 6 Image Pull Policy</strong>
<label for=toc-control><img src=/kustz/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#镜像拉取鉴权>镜像拉取鉴权</a></li><li><a href=#镜像拉去策略>镜像拉去策略</a></li><li><a href=#使用>使用</a></li></ul></nav></aside></header><article class=markdown><h1 id=36-镜像拉取鉴权和策略>3.6. 镜像拉取鉴权和策略
<a class=anchor href=#36-%e9%95%9c%e5%83%8f%e6%8b%89%e5%8f%96%e9%89%b4%e6%9d%83%e5%92%8c%e7%ad%96%e7%95%a5>#</a></h1><blockquote><p>大家好， 我是老麦。
今天我们解决镜像拉取鉴权和策略</p></blockquote><p><img src=./img/kustz-logo.jpg alt=logo></p><h2 id=镜像拉取鉴权>镜像拉取鉴权
<a class=anchor href=#%e9%95%9c%e5%83%8f%e6%8b%89%e5%8f%96%e9%89%b4%e6%9d%83>#</a></h2><p>拉取私有镜像或私有仓库镜像的时候， 需要提供鉴权信息。</p><p>在 Kubernets 中， 通过 Secret 管理账号这些账号信息。 Secret 类型分为两种，</p><ol><li><p><code>kubernetes.io/dockerconfigjson</code>: 如果有linux安装了 docker， 就是 <code>~/.docker/config.json</code> 这个文件。</p></li><li><p><code>kubernetes.io/dockercfg</code>: 不太熟。</p></li></ol><p>在 <code>/pkg/tokube/pod.go</code> 中， 可以看到 <code>ImagePullSecrets</code> 的处理方法。 就是将字符串转为 kubernetes 的引用对象， 其它没什么好说的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ImagePullSecrets</span>(<span style=color:#a6e22e>secrets</span> []<span style=color:#66d9ef>string</span>) []<span style=color:#a6e22e>corev1</span>.<span style=color:#a6e22e>LocalObjectReference</span> {
	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>secrets</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
	}
	<span style=color:#a6e22e>objs</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>corev1</span>.<span style=color:#a6e22e>LocalObjectReference</span>{}
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>secrets</span> {
		<span style=color:#a6e22e>objs</span> = append(<span style=color:#a6e22e>objs</span>, <span style=color:#a6e22e>corev1</span>.<span style=color:#a6e22e>LocalObjectReference</span>{
			<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>s</span>,
		})
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>objs</span>
}
</code></pre></div><h2 id=镜像拉去策略>镜像拉去策略
<a class=anchor href=#%e9%95%9c%e5%83%8f%e6%8b%89%e5%8e%bb%e7%ad%96%e7%95%a5>#</a></h2><p>镜像拉去策略分为三种， <code>Never, Always, IfNotPresent</code></p><p>在 <code>/pkg/tokube/container.go</code> 中， 可以看到 <code>ImagePullPolicy</code> 的处理方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ImagePullPolicy</span>(<span style=color:#a6e22e>s</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>corev1</span>.<span style=color:#a6e22e>PullPolicy</span> {
	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>s</span>) {
	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;always&#34;</span>:
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>corev1</span>.<span style=color:#a6e22e>PullAlways</span>
	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;never&#34;</span>:
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>corev1</span>.<span style=color:#a6e22e>PullNever</span>
	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;ifnotpresent&#34;</span>:
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>corev1</span>.<span style=color:#a6e22e>PullIfNotPresent</span>
	}
	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
}
</code></pre></div><ol><li>在 <code>kustz.yml</code> 不再大小写敏感， 因为我们将值全部转为小写。</li><li>当不指定配置策略的时候， 使用默认策略。</li></ol><h2 id=使用>使用
<a class=anchor href=#%e4%bd%bf%e7%94%a8>#</a></h2><p>如果在 <code>kustz.yml</code> 配置中， 通过如下配置。</p><p>假设配置文件名为 <code>docker-config.json</code>， 支持多个账号， 参考如下。</p><pre><code class=language-json5 data-lang=json5>// docker-config.json
{
	&quot;auths&quot;: {
		&quot;ghcr.io&quot;: {
			&quot;auth&quot;: &quot;Abcdefg==&quot;
		},
		&quot;https://index.docker.io/v1/&quot;: {
			&quot;auth&quot;: &quot;Abcdefg=&quot;
		}
	}
}
</code></pre><p><code>auth</code> 值是 <code>user:password</code> 的 base64 编码。 如果不知道怎么弄 <code>docker login</code> 生成</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker login -u myUser -p myPass
</code></pre></div><p>在 <code>kustz.yml</code> 中， 通过 <code>docker-config.json</code> 创建 Secret 并引用。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>service</span>:
  <span style=color:#f92672>imagePullSecrets</span>:
    - <span style=color:#ae81ff>aliyun-repo</span>

<span style=color:#f92672>secrets</span>:
  <span style=color:#f92672>files</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aliyun-repo</span>
      <span style=color:#f92672>files</span>:
        - <span style=color:#ae81ff>.dockerconfigjson=docker-config.json</span>
      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>kubernetes.io/dockerconfigjson</span>
</code></pre></div></article><div class="book-footer justify-between"></div><hr style=height:1px;background:var(--gray-200)><br><p>本图书由<a href=https://github.com/tangx>老麦</a>©2021 版权所有，<a href=https://github.com/tangx/kubebuilder-zero-to-one>所有文章</a>采用<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh>知识署名-非商业性使用-禁止演绎 4.0 国际</a>进行许可。</p><div style=text-align:center><p><img width=70% style=width:70%;height:70%;!important src=https://tangx.in/assets/images/wx-qrcode.png></p></div><script src=https://utteranc.es/client.js repo=tangx/tangx.github.io issue-term=title theme=github-light crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tangx/kubebuilder-zero-to-one/edit/master/./03-6-image-pull-policy.md target=_blank rel=noopener><img src=/kustz/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#镜像拉取鉴权>镜像拉取鉴权</a></li><li><a href=#镜像拉去策略>镜像拉去策略</a></li><li><a href=#使用>使用</a></li></ul></nav></div></aside></main></body></html>