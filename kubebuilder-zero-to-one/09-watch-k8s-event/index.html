<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="监听 k8s 事件 #  之前的代码遗留了一个问题， 当手动通过命令删除 pod 时候， 不会出发 redis.Finalizers 的更新， 也不会重建被删除的 Pod， 实现效果并不好
kubectl delete pod pod_name 1. 监听事件 #  在 /controllers/redis_controller.go 中生成了对象和方法监听 k8s 的事件。
ctrl 创建的 Builder 可以通过 链式 调用方式， 监听多个 k8s 对象的事件。
// SetupWithManager sets up the controller with the Manager. func (r *RedisReconciler) SetupWithManager(mgr ctrl.Manager) error { return ctrl.NewControllerManagedBy(mgr). For(&myappv1.Redis{}). // 监听 pod 事件 	Watches( &source.Kind{Type: &corev1.Pod{}}, handler.Funcs{DeleteFunc: r.podDeleteHandler}, ). Watches( &source.Kind{Type: &v1.Service{},}, handler."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content><meta property="og:description" content="监听 k8s 事件 #  之前的代码遗留了一个问题， 当手动通过命令删除 pod 时候， 不会出发 redis.Finalizers 的更新， 也不会重建被删除的 Pod， 实现效果并不好
kubectl delete pod pod_name 1. 监听事件 #  在 /controllers/redis_controller.go 中生成了对象和方法监听 k8s 的事件。
ctrl 创建的 Builder 可以通过 链式 调用方式， 监听多个 k8s 对象的事件。
// SetupWithManager sets up the controller with the Manager. func (r *RedisReconciler) SetupWithManager(mgr ctrl.Manager) error { return ctrl.NewControllerManagedBy(mgr). For(&myappv1.Redis{}). // 监听 pod 事件 	Watches( &source.Kind{Type: &corev1.Pod{}}, handler.Funcs{DeleteFunc: r.podDeleteHandler}, ). Watches( &source.Kind{Type: &v1.Service{},}, handler."><meta property="og:type" content="article"><meta property="og:url" content="https://books.tangx.in/kubebuilder-zero-to-one/09-watch-k8s-event/"><meta property="article:section" content><title>09 Watch K8s Event | kuberbuilder 从零开始</title><link rel=manifest href=/kubebuilder-zero-to-one/manifest.json><link rel=icon href=/kubebuilder-zero-to-one/favicon.png type=image/x-icon><link rel=stylesheet href=/kubebuilder-zero-to-one/book.min.958cea7827621d6fbcb3acf091344c3e44e3d2a9428f9c3c38bb9eb37bf8c45d.css integrity="sha256-lYzqeCdiHW+8s6zwkTRMPkTj0qlCj5w8OLues3v4xF0=" crossorigin=anonymous><script defer src=/kubebuilder-zero-to-one/flexsearch.min.js></script><script defer src=/kubebuilder-zero-to-one/en.search.min.b240837310cbbf88bada263f42c3b64a4bdab8fbe3fac84079672488c5436fa7.js integrity="sha256-skCDcxDLv4i62iY/QsO2SkvauPvj+shAeWckiMVDb6c=" crossorigin=anonymous></script><script defer src=/kubebuilder-zero-to-one/sw.min.3d625323bdf8eed675374c65d2c3b79dc95f48e4919d7e367a04f8350f60cc5e.js integrity="sha256-PWJTI7347tZ1N0xl0sO3nclfSOSRnX42egT4NQ9gzF4=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/kubebuilder-zero-to-one/><img src=/kubebuilder-zero-to-one/logo.png alt=Logo><span>kuberbuilder 从零开始</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><h1 id=目录>目录
<a class=anchor href=#%e7%9b%ae%e5%bd%95>#</a></h1><ol><li><a href=/kubebuilder-zero-to-one/01-kubebuilder-init-project/>使用 kuberbuilder 初始化项目</a></li><li><a href=/kubebuilder-zero-to-one/02-simplest-redis-crd/>简单跑一跑</a></li><li><a href=/kubebuilder-zero-to-one/03-deploy-crd-controller/>发布 crd controller</a></li><li><a href=/kubebuilder-zero-to-one/04-filed-validation-by-comment/>使用注解完整字段值约束</a></li><li><a href=/kubebuilder-zero-to-one/05-filed-validation-by-webhook/>通过 webhook 进行字段验证</a></li><li><a href=/kubebuilder-zero-to-one/06-create-pod-by-redis-operator/>使用 Operator 创建并发布一个 Pod</a></li><li>K8S 父子资源删除管理<ol><li><a href=/kubebuilder-zero-to-one/07-1-delete-pod-by-redis-ownerreference/>使用 OwnerReference 管理 redis operator 创建的 Pod</a></li><li><a href=/kubebuilder-zero-to-one/07-2-delete-pod-by-finalizers/>使用 finalizers 管理 redis operator 创建的 Pod</a></li></ol></li><li><a href=/kubebuilder-zero-to-one/08-scale-pod/>Pod 扩容与缩容</a></li><li><a href=/kubebuilder-zero-to-one/09-watch-k8s-event/ class=active>监听 k8s 事件</a></li><li><a href=/kubebuilder-zero-to-one/10-recreate-deleted-pod/>重建被删除的 Pod</a></li><li><a href=/kubebuilder-zero-to-one/11-official-package-optimize/>使用 controllerutil 优化代码</a></li><li><a href=/kubebuilder-zero-to-one/12-add-event/>增加 event 事件支持</a></li><li><a href=/kubebuilder-zero-to-one/13-add-status/>添加 Status 状态字段</a></li></ol></nav><script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/kubebuilder-zero-to-one/svg/menu.svg class=book-icon alt=Menu></label>
<strong>09 Watch K8s Event</strong>
<label for=toc-control><img src=/kubebuilder-zero-to-one/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#1-监听事件>1. 监听事件</a></li><li><a href=#2-事件方法>2. 事件方法</a></li><li><a href=#3-监听的资源与权限>3. 监听的资源与权限</a></li></ul></nav></aside></header><article class=markdown><h1 id=监听-k8s-事件>监听 k8s 事件
<a class=anchor href=#%e7%9b%91%e5%90%ac-k8s-%e4%ba%8b%e4%bb%b6>#</a></h1><p>之前的代码遗留了一个问题， 当手动通过命令删除 pod 时候， 不会出发 <code>redis.Finalizers</code> 的更新， 也不会重建被删除的 Pod， 实现效果并不好</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete pod pod_name
</code></pre></div><h2 id=1-监听事件>1. 监听事件
<a class=anchor href=#1-%e7%9b%91%e5%90%ac%e4%ba%8b%e4%bb%b6>#</a></h2><p>在 <code>/controllers/redis_controller.go</code> 中生成了对象和方法监听 k8s 的事件。</p><p>ctrl 创建的 <code>Builder</code> 可以通过 <strong>链式</strong> 调用方式， 监听多个 k8s 对象的事件。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// SetupWithManager sets up the controller with the Manager.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisReconciler</span>) <span style=color:#a6e22e>SetupWithManager</span>(<span style=color:#a6e22e>mgr</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Manager</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>NewControllerManagedBy</span>(<span style=color:#a6e22e>mgr</span>).
		<span style=color:#a6e22e>For</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myappv1</span>.<span style=color:#a6e22e>Redis</span>{}).
		<span style=color:#75715e>// 监听 pod 事件
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>Watches</span>(
			<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>source</span>.<span style=color:#a6e22e>Kind</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>corev1</span>.<span style=color:#a6e22e>Pod</span>{}},
			<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Funcs</span>{<span style=color:#a6e22e>DeleteFunc</span>: <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>podDeleteHandler</span>},
		).
		<span style=color:#a6e22e>Watches</span>(
			<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>source</span>.<span style=color:#a6e22e>Kind</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Service</span>{},},
			<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Funcs</span>{<span style=color:#a6e22e>DeleteFunc</span>: <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>podDeleteHandler</span>},
		).
		<span style=color:#a6e22e>Complete</span>(<span style=color:#a6e22e>r</span>)
}
</code></pre></div><p>上述代码中， 使用 <code>Watches</code> 方法监听了 <strong>Pod</strong> 和 <strong>Service</strong> 的事件。 <code>Watch</code> 的两个参数</p><ol><li>监听事件对象( <code>source.Source</code>): 可以是 <code>source.Kind</code>、 <code>source.Channel</code> 或 <code>source.Informer</code>。</li><li>监听事件行为( <code>handler.EventHandler</code> ): 当事件对象发生满足条件时所触发的行为。<ul><li>Create: 对应 CreateFunc ， 满足 <strong>创建</strong> 条件是触发</li><li>Update: 对应 UpdateFunc ， 满足 <strong>更新</strong> 条件是触发</li><li>Delete: 对应 DeleteFunc ， 满足 <strong>删除</strong> 条件是触发</li><li>Generic: 对应 GenericFunc ， 满足 <strong>未知</strong> 条件是触发</li></ul></li></ol><h2 id=2-事件方法>2. 事件方法
<a class=anchor href=#2-%e4%ba%8b%e4%bb%b6%e6%96%b9%e6%b3%95>#</a></h2><p>每个事件方法都支持 2个 参数， <strong>事件</strong> 与 <strong>工作队列</strong> 。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Funcs implements EventHandler.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Funcs</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#75715e>// Create is called in response to an add event.  Defaults to no-op.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// RateLimitingInterface is used to enqueue reconcile.Requests.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>CreateFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>CreateEvent</span>, <span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>RateLimitingInterface</span>)

	<span style=color:#75715e>// Update is called in response to an update event.  Defaults to no-op.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// RateLimitingInterface is used to enqueue reconcile.Requests.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>UpdateFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>UpdateEvent</span>, <span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>RateLimitingInterface</span>)

	<span style=color:#75715e>// Delete is called in response to a delete event.  Defaults to no-op.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// RateLimitingInterface is used to enqueue reconcile.Requests.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>DeleteFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>DeleteEvent</span>, <span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>RateLimitingInterface</span>)

	<span style=color:#75715e>// GenericFunc is called in response to a generic event.  Defaults to no-op.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// RateLimitingInterface is used to enqueue reconcile.Requests.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>GenericFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>GenericEvent</span>, <span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>RateLimitingInterface</span>)
}
</code></pre></div><p>通过事件， 可以拿到对象应变化的对象。 有了这些对象， 就可以定制更多的行为。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisReconciler</span>) <span style=color:#a6e22e>podDeleteHandler</span>(<span style=color:#a6e22e>e</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>DeleteEvent</span>, <span style=color:#a6e22e>q</span> <span style=color:#a6e22e>workqueue</span>.<span style=color:#a6e22e>RateLimitingInterface</span>) {

	<span style=color:#a6e22e>pname</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Object</span>.<span style=color:#a6e22e>GetName</span>()
	<span style=color:#a6e22e>pns</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Object</span>.<span style=color:#a6e22e>GetNamespace</span>()
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Pod %s in NS %s 被删除\n&#34;</span>, <span style=color:#a6e22e>pname</span>, <span style=color:#a6e22e>pns</span>)

}
</code></pre></div><p>上述是拿到 Pod 删除事件后， 打印出相关日志信息。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>krm -f deploy/

    Pod my-op-redis-1 in NS k8s-operator-demo-system 被删除
    Pod my-op-redis-0 in NS k8s-operator-demo-system 被删除
</code></pre></div><h2 id=3-监听的资源与权限>3. 监听的资源与权限
<a class=anchor href=#3-%e7%9b%91%e5%90%ac%e7%9a%84%e8%b5%84%e6%ba%90%e4%b8%8e%e6%9d%83%e9%99%90>#</a></h2><p>既然是监听 k8s 资源， 那就必须对所监听的资源有响应的权限。</p><p>以下的日志报错就是因为没有提前授权 Service 的权限造成的。</p><pre><code class=language-log data-lang=log>E1123 08:10:53.183975       1 reflector.go:138] pkg/mod/k8s.io/client-go@v0.22.1/tools/cache/reflector.go:167: Failed to watch *v1.Service: failed to list *v1.Service: services is forbidden: User &quot;system:serviceaccount:k8s-operator-demo-system:k8s-operator-demo-controller-manager&quot; cannot list resource &quot;services&quot; in API group &quot;&quot; at the cluster scope
</code></pre><p>解决方法和之前提到的一样， 通过 kubebuilder 的注解方法生成对应的 rbac 权限。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>//+kubebuilder:rbac:groups=&#34;&#34;,resources=services,verbs=get;list;watch;create;update;patch;delete
</span></code></pre></div></article><div class="book-footer justify-between"></div><hr style=height:1px;background:var(--gray-200)><br><p>本图书由<a href=https://github.com/tangx>老麦</a>©2021 版权所有，<a href=https://github.com/tangx/kubebuilder-zero-to-one>所有文章</a>采用<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh>知识署名-非商业性使用-禁止演绎 4.0 国际</a>进行许可。</p><div style=text-align:center><p><img width=70% style=width:70%;height:70%;!important src=https://tangx.in/assets/images/wx-qrcode.png></p></div><script src=https://utteranc.es/client.js repo=tangx/tangx.github.io issue-term=title theme=github-light crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tangx/kubebuilder-zero-to-one/edit/master/./09-watch-k8s-event.md target=_blank rel=noopener><img src=/kubebuilder-zero-to-one/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#1-监听事件>1. 监听事件</a></li><li><a href=#2-事件方法>2. 事件方法</a></li><li><a href=#3-监听的资源与权限>3. 监听的资源与权限</a></li></ul></nav></div></aside></main></body></html>